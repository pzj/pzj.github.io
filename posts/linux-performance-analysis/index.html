<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Linux性能分析" /><meta name="author" content="pzhjie" /><meta property="og:locale" content="en_US" /><meta name="description" content="Linux性能分析" /><meta property="og:description" content="Linux性能分析" /><link rel="canonical" href="https://pzhjie.com//posts/linux-performance-analysis/" /><meta property="og:url" content="https://pzhjie.com//posts/linux-performance-analysis/" /><meta property="og:site_name" content="章杰的博客" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-09-17T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Linux性能分析" /><meta name="twitter:site" content="@CodeHungry" /><meta name="twitter:creator" content="@pzhjie" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"pzhjie"},"description":"Linux性能分析","url":"https://pzhjie.com//posts/linux-performance-analysis/","@type":"BlogPosting","headline":"Linux性能分析","dateModified":"2022-03-29T15:00:34+08:00","datePublished":"2018-09-17T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://pzhjie.com//posts/linux-performance-analysis/"},"@context":"https://schema.org"}</script><title>Linux性能分析 | 章杰的博客</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/files/IMG_7890.JPG" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">章杰的博客</a></div><div class="site-subtitle font-italic">base on Jekyll theme.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于我</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/pzj" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/CodeHungry" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['pzhjie','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Linux性能分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Linux性能分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 17, 2018, 12:00 AM +0800" > Sep 17, 2018 <i class="unloaded">2018-09-17T00:00:00+08:00</i> </span> by <span class="author"> pzhjie </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 29, 2022, 3:00 PM +0800" > Mar 29 <i class="unloaded">2022-03-29T15:00:34+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4946 words">27 min</span></div></div><div class="post-content"><h3 id="1-uptime">1. uptime</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span><span class="nb">uptime
 </span>20:11:28 up 148 days,  8:09,  1 user,  load average: 0.08, 0.08, 0.03
</pre></table></code></div></div><p>这个命令显示了要运行的任务（进程）数，通过它能够快速了解系统的平均负载。在Linux上，这些数值既包括正在或准备运行在CPU上的进程，也包括阻塞在uninterruptible I/O（通常是磁盘I/O）上的进程。它展示了资源负载（或需求）的大致情况。</p><p>最右的三个数值分别是1分钟、5分钟、15分钟系统负载的平均值。</p><h3 id="2-dmesg--tail">2. dmesg | tail</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie@centos217 ~]<span class="nv">$ </span>dmesg | <span class="nb">tail
</span>UDP: bad checksum. From 60.191.23.60:8312 to 183.36.122.217:1080 ulen 109
……
</pre></table></code></div></div><p>这个命令显示了最新的10个系统信息，如果有的话。注意会导致性能问题的错误信息。上面的例子里就包括对过多占用内存的进程错误(oom)，还有丢弃TCP请求的公告。</p><h3 id="3-free--m">3. free -m</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>free <span class="nt">-m</span>
             total       used       free     shared    buffers     cached
Mem:         48135      14972      33162          0        461       5622
-/+ buffers/cache:       8889      39246
Swap:         7629          0       7629

</pre></table></code></div></div><p>右边的两列显示： buffers：用于块设备I/O的缓冲区缓存 cached：用于文件系统的页缓存 它们的值接近于0时，往往导致较高的磁盘I/O（可以通过iostat确认）。</p><p>比起第一行，-/+ buffers/cache提供的内存使用量会更加准确些。Linux会把暂时用不上的内存用作缓存，一旦应用需要的时候立刻重新分配给它。所以部分被用作缓存的内存其实也算是空闲内存，第二行以此修订了实际的内存使用量。为了解释这一点， 有人专门建了个网站： linuxatemyram。</p><h3 id="4-vmstat-1">4. vmstat 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>vmstat 1
procs <span class="nt">-----------memory----------</span> <span class="nt">---swap--</span> <span class="nt">-----io----</span> <span class="nt">--system--</span> <span class="nt">-----cpu-----</span>
 r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="k">in   </span>cs us sy <span class="nb">id </span>wa st
 2  0      0 38261304 471000 5813820    0    0     0     2    0    0  1  0 99  0  0	
 0  0      0 38224276 471000 5813824    0    0     0     4 9365 14501  9  2 89  0  0	
</pre></table></code></div></div><p>vmstat，是“virtual memory stat”的简称，几十年前就已经包括在BSD套件之中。它会逐行输出服务器关键数据的统计结果。(1表示每秒采样一次)。</p><p>检查下面各列：</p><blockquote><p>procs 进程信息字段</p></blockquote><p>r：等待CPU的进程数。该指标能更好地判定CPU是否饱和，因为它不包括I/O。简单地说，r值高于CPU数时就意味着饱和。数量越大，系统越繁忙</p><p>b: 等待IO的进程数量，数量越大，系统越繁忙</p><p>memory 内存信息字段(单位为 KB)</p><blockquote><p>swpd：虚拟内存的使用情况</p></blockquote><p>free：空闲的内存千字节数。如果你数不清有多少位，就说明系统内存是充足的。使用free -m，能够更清楚地说明空闲内存的状态。</p><blockquote><p>swap 交换分区信息字段</p></blockquote><p>si，so：Swap-ins和Swap-outs，每秒从磁盘读入/写入磁盘的大小。如果它们不为零，意味着内存已经不足，开始动用交换空间了需要经常在磁盘和内存之间进行交换，系统性能越差。</p><blockquote><p>io 磁盘读/写信息字段</p></blockquote><p>bi bo：块设备每秒接收/发送的块数量。两个数越大，代表系统的 I/O 越繁忙。</p><blockquote><p>system 系统信息字段</p></blockquote><p>in：每秒被中断的进程次数 cs：每秒进行的事件切换次数 这两个数越大，代表系统与接口设备的通信越繁忙</p><blockquote><p>cup CPU信息字段（单位：百分比）</p></blockquote><p>us，sy，id，wa，st：它们是所有CPU的使用百分比。它们分别表示user time，system time（处于内核态的时间），idle(空闲)，wait(等待) I/O和steal time（偷取时间，与虚拟机相关）。</p><p>通过相加us和sy的百分比，你可以确定CPU是否处于忙碌状态。一个持续不变的wait I/O意味着瓶颈在硬盘上，这种情况往往伴随着CPU的空闲，因为任务都卡在磁盘I/O上了。你可以把wait I/O当作CPU空闲的另一种形式，它额外给出了CPU空闲的线索。</p><h3 id="5-mpstat--p-all-1">5. mpstat -P ALL 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie@centos ~]<span class="nv">$ </span>mpstat <span class="nt">-P</span> ALL 1
Linux 2.6.32-504.16.2.el6.x86_64 <span class="o">(</span>centos<span class="o">)</span> 09/19/2018 	_x86_64_	<span class="o">(</span>16 CPU<span class="o">)</span>

08:19:56 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle
08:19:57 PM  all    0.44    0.00    0.13    0.00    0.00    0.00    0.00    0.00   99.44
08:19:57 PM    0    2.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   97.00
08:19:57 PM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
08:19:57 PM    2    1.01    0.00    0.00    0.00    0.00    0.00    0.00    0.00   98.99
</pre></table></code></div></div><p>mpstat是Multiprocessor Statistics的缩写，是实时系统监控工具。其报告与CPU的一些统计信息，这些信息存放在/proc/stat文件中。在多CPUs系统里，其不但能查看所有CPU的平均状况信息，而且能够查看特定CPU的信息。mpstat最大的特点是：可以查看多核心cpu中每个计算核心的统计数据；而类似工具vmstat只能查看系统整体cpu情况。这个命令显示每个CPU的时间使用百分比，可以用它来检查CPU是否存在负载不均衡。单个过于忙碌的CPU可能意味着整个应用只有单个线程在工作。</p><h3 id="6-pidstat-1">6. pidstat 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>pidstat 1
Linux 2.6.32-504.16.2.el6.x86_64 <span class="o">(</span>centos<span class="o">)</span> 	09/19/2018 	_x86_64_	<span class="o">(</span>16 CPU<span class="o">)</span>

08:21:13 PM       PID    %usr %system  %guest    %CPU   CPU  Command
08:21:14 PM     14721    0.98    0.00    0.00    0.98     0  fts_task_redis_
08:21:14 PM     17931    0.98    0.00    0.00    0.98     1  python
08:21:14 PM     19907    0.98    0.00    0.00    0.98    10  yyms_agent_d
</pre></table></code></div></div><p>pidstat看上去就像top，不过top的输出会覆盖掉之前的输出，而pidstat的输出则添加在之前的输出的后面。这有利于观察数据随时间的变动情况，也便于把你看到的内容复制粘贴到调查报告中。</p><h3 id="7-iostat--xz-1">7. iostat -xz 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>iostat <span class="nt">-xz</span> 1
Linux 2.6.32-504.16.2.el6.x86_64 <span class="o">(</span>centos<span class="o">)</span> 	09/19/2018 	_x86_64_	<span class="o">(</span>16 CPU<span class="o">)</span>

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.33    0.00    0.20    0.01    0.00   99.46

Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.00     6.49    0.03    3.57     0.90    80.49    22.60     0.00    0.54   0.39   0.14
sdb               0.00     0.00    0.00    0.07     0.00     0.55     8.24     0.00    0.73   0.73   0.00
</pre></table></code></div></div><p>iostat参数 -x 显示详细信息<br /> -z 只显示在采样周期内有活动的磁盘</p><p>这个命令可以弄清块设备（磁盘）的状况，包括工作负载和处理性能。注意以下各项：</p><p>r/s，w/s，rkB/s，wkB/s：分别表示每秒设备读次数，写次数，读的KB数，写的KB数。它们描述了磁盘的工作负载。也许性能问题就是由过高的负载所造成的。</p><p>await：I/O平均时间(毫秒)。它是应用中I/O处理所实际消耗的时间，因为其中既包括排队用时也包括处理用时。如果它比预期的大，就意味着设备饱和了，或者设备出了问题。</p><p>svctm：平均每次设备I/O操作的服务时间 (毫秒).即 delta(use)/delta(rio+wio).</p><p>avgqu-sz：分配给设备的平均请求数。大于1表示设备已经饱和了。（不过有些设备可以并行处理请求，比如由多个磁盘组成的虚拟设备）</p><p>%util：设备使用率，一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比。接近100%通常意味着饱和。</p><p>cup使用率与负载区别？</p><p>如果某个存储设备是由多个物理磁盘组成的逻辑磁盘设备，100%的使用率可能只是意味着I/O占用</p><p>请牢记于心，disk I/O性能低不一定是个问题。应用的I/O往往是异步的（比如预读（read-ahead）和写缓冲（buffering for writes）），所以不一定会被阻塞并遭受延迟。</p><p>如果 %util 接近 100%，说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。 idle小于70% IO压力就较大了，一般读取速度有较多的wait。 同时可以结合vmstat 查看查看b参数(等待资源的进程数)和wa参数(IO等待所占用的CPU时间的百分比，高过30%时IO压力高)。</p><p>另外 await 的参数也要多和 svctm 来参考。差的过高就一定有 IO 的问题。</p><p>avgqu-sz 也是个做 IO 调优时需要注意的地方，这个就是直接每次操作的数据的大小，如果次数多，但数据拿的小的话，其实 IO 也会很小。如果数据拿的大，才IO 的数据会高。也可以通过 avgqu-sz × ( r/s or w/s ) = rsec/s or wsec/s。也就是讲，读定速度是这个来决定的。</p><p>svctm 一般要小于 await (因为同时等待的请求的等待时间被重复计算了)，svctm 的大小一般和磁盘性能有关，CPU/内存的负荷也会对其有影响，请求过多也会间接导致 svctm 的增加。await 的大小一般取决于服务时间(svctm) 以及 I/O 队列的长度和 I/O 请求的发出模式。如果 svctm 比较接近 await，说明 I/O 几乎没有等待时间；如果 await 远大于 svctm，说明 I/O 队列太长，应用得到的响应时间变慢，如果响应时间超过了用户可以容许的范围，这时可以考虑更换更快的磁盘，调整内核 elevator 算法，优化应用，或者升级 CPU。</p><p>队列长度(avgqu-sz)也可作为衡量系统 I/O 负荷的指标，但由于 avgqu-sz 是按照单位时间的平均值，所以不能反映瞬间的I/O量。</p><p>形象的比喻：<br /> r/s+w/s 类似于交款人的总数<br /> 平均队列长度(avgqu-sz)类似于单位时间里平均排队人的个数<br /> 平均服务时间(svctm)类似于收银员的收款速度<br /> 平均等待时间(await)类似于平均每人的等待时间<br /> 平均I/O数据(avgrq-sz)类似于平均每人所买的东西多少<br /> I/O 操作率 (%util)类似于收款台前有人排队的时间比例<br /> 设备IO操作:总IO(io)/s = r/s(读) +w/s(写)</p><p>平均等待时间=单个I/O服务器时间*(1+2+…+请求总数-1)/请求总数<br /> 每秒发出的I/0请求很多,但是平均队列就4,表示这些请求比较均匀,大部分处理还是比较及时。</p><blockquote><p>sar是System Activity Reporter（系统活动情况报告）的缩写。sar工具将对系统当前的状态进行取样，然后通过计算数据和比例来表达系统的当前运行状态。它的特点是可以连续对系统取样，获得大量的取样数据；取样数据和分析的结果都可以存入文件，所需的负载很小。sar是目前Linux上最为全面的系统性能分析工具之一，可以从14个大方面对系统的活动进行报告，包括文件的读写情况、系统调用的使用情况、串口、CPU效率、内存使用状况、进程活动及IPC有关的活动等，使用也是较为复杂。</p></blockquote><h3 id="8-sar--n-dev-1">8. sar -n DEV 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>sar <span class="nt">-n</span> DEV 1
Linux 2.6.32-504.16.2.el6.x86_64 <span class="o">(</span>centos<span class="o">)</span> 	09/19/2018 	_x86_64_	<span class="o">(</span>16 CPU<span class="o">)</span>

08:25:37 PM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s
08:25:38 PM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00
08:25:38 PM      eth0   2107.07   1957.58    347.10   1035.85      0.00      0.00      0.00
08:25:38 PM      eth1      4.04      1.01      0.27      0.10      0.00      0.00      0.00
08:25:38 PM      eth2      0.00      0.00      0.00      0.00      0.00      0.00      0.00
08:25:38 PM      eth3      0.00      0.00      0.00      0.00      0.00      0.00      0.00

</pre></table></code></div></div><p>这个命令可以用于检查网络流量的工作负载：rxkB/s 和 txkB/s，以及它是否达到限额了。上面的例子中，eth0接收的流量达到 2Mbytes/s。</p><h3 id="9-sar--n-tcpetcp-1">9. sar -n TCP,ETCP 1</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>sar <span class="nt">-n</span> TCP,ETCP 1
Linux 2.6.32-504.16.2.el6.x86_64 <span class="o">(</span>centos<span class="o">)</span> 	09/19/2018 	_x86_64_	<span class="o">(</span>16 CPU<span class="o">)</span>

02:49:37 PM  active/s passive/s    iseg/s    oseg/s
02:49:38 PM      2.00      1.00   6753.00   8823.00

02:49:37 PM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s
02:49:38 PM      0.00      0.00      1.00      0.00      1.00

</pre></table></code></div></div><p>这个命令显示一些关键TCP指标的汇总。其中包括：<br /> active/s：本地每秒创建的TCP连接数（比如connect()创建的）<br /> passive/s：远程每秒创建的TCP连接数（比如accept()创建的）<br /> iseg/s：接收的段（传输层以段为传输单位），单位是：段/s<br /> oseg/s：发送的段</p><p>atmptf/s：每秒尝试连接但失败的连接数<br /> estres/s：每秒从ESTABLISHED/CLOSE-WAIT状态转移到到CLOSED状态的TCP连接數目<br /> retrans/s：每秒TCP重传次数<br /> isegerr/s：每秒收到的error的segments數量(比如checksum错误)<br /> orsts/s：每秒送出的的包含RST flag的segments數量</p><p>retrans 重传是网络或系统问题的一个信号；它可能是不可靠的网络（比如公网）所造成的，也有可能是服务器已经过载并开始丢包。</p><h3 id="10-top">10. top</h3><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="o">[</span>pengzhangjie]<span class="nv">$ </span>top
top - 20:11:53 up 148 days,  8:10,  2 user,  load average: 0.06, 0.08, 0.03
Tasks: 316 total,   1 running, 315 sleeping,   0 stopped,   0 zombie
Cpu<span class="o">(</span>s<span class="o">)</span>:  0.9%us,  0.3%sy,  0.0%ni, 98.8%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:  49290640k total, 11046268k used, 38244372k free,   471000k buffers
Swap:  7813116k total,        0k used,  7813116k free,  5813764k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                                  
23715 rabbitmq  20   0 9715m 259m 4212 S 113.4  0.5  29651:55 beam.smp                                                                                                                 
45098 root      20   0 4259m 3.1g 1244 S  3.9  6.6  32:10.98 fts_shared_redi                                                                                                           
23936 root      20   0 1915m  44m 4272 S  2.0  0.1 639:18.96 yyac_worker_ant 
</pre></table></code></div></div><p>统计信息区：</p><p>前五行是当前系统情况整体的统计信息区。下面我们看每一行信息的具体意义。</p><blockquote><p>第一行，任务队列信息，同 uptime 命令的执行结果，具体参数说明情况如下：</p></blockquote><p>20:11:53 — 当前系统时间</p><p>up 148 days, 8:10 — 系统已经运行了148天8小时10分钟（在这期间系统没有重启过的吆！）</p><p>2 users — 当前有2个用户登录系统</p><p>load average: 0.06, 0.08, 0.03 — load average后面的三个数分别是1分钟、5分钟、15分钟的负载情况。</p><p>load average数据是每隔5秒钟检查一次活跃的进程数，然后按特定算法计算出的数值。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。</p><blockquote><p>第二行，Tasks — 任务（进程），具体信息说明如下：</p></blockquote><p>系统现在共有316个进程，其中处于运行中的有1个，315个在休眠（sleep），stoped状态的有0个，zombie状态（僵尸）的有0个。</p><blockquote><p>第三行，cpu状态信息，具体属性说明如下：</p></blockquote><p>0.9%us — 用户空间占用CPU的百分比。</p><p>0.3%sy — 内核空间占用CPU的百分比。</p><p>0.0%ni — 改变过优先级的进程占用CPU的百分比</p><p>98.8% id — 空闲CPU百分比</p><p>0.0% wa — IO等待占用CPU的百分比</p><p>0.0% hi — 硬中断（Hardware IRQ）占用CPU的百分比</p><p>0.2% si — 软中断（Software Interrupts）占用CPU的百分比</p><blockquote><p>第四行 内存状态，具体信息如下：</p></blockquote><p>49290640k total — 物理内存总量（49GB）</p><p>11046268k used — 使用中的内存总量（11GB）</p><p>38244372k free — 空闲内存总量（38GB）</p><p>471000k buffers — 缓存的内存量 （471M）</p><blockquote><p>第五行，swap交换分区信息，具体信息说明如下：</p></blockquote><p>7813116k total — 交换区总量（7.8GB）</p><p>0k used — 使用的交换区总量（0K）</p><p>7813116k free — 空闲交换区总量（7.8GB）</p><p>5813764k cached — 缓冲的交换区总量（5.8GB）</p><p>备注：</p><p>第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心。</p><p>对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。</p><blockquote><p>第六行，空行。</p></blockquote><blockquote><p>第七行以下：各进程（任务）的状态监控，项目列信息说明如下：</p></blockquote><p>PID — 进程id</p><p>USER — 进程所有者</p><p>PR — 进程优先级</p><p>NI — nice值。负值表示高优先级，正值表示低优先级</p><p>VIRT — 进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</p><p>RES — 进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</p><p>SHR — 共享内存大小，单位kb</p><p>S — 进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程</p><p>%CPU — 上次更新到现在的CPU时间占用百分比</p><p>%MEM — 进程使用的物理内存百分比</p><p>TIME+ — 进程使用的CPU时间总计，单位1/100秒</p><p>COMMAND — 进程名称（命令名/命令行）</p><blockquote><p>其他使用技巧：</p></blockquote><ul><li><p>多U多核CPU监控，在top基本视图中，按键盘数字“1”，可监控每个逻辑CPU的状况</p><li><p>高亮显示当前运行进程，敲击键盘“b”（打开/关闭加亮效果）</p><li><p>进程字段排序 默认进入top时，各进程是按照CPU的占用量来排序的，敲击键盘“x”（打开/关闭排序列的加亮效果）</p><li><p>通过”shift + &gt;”或”shift + &lt;”可以向右或左改变排序列</p><li><p>top交互命令</p><p>在top 命令执行过程中可以使用的一些交互命令。这些命令都是单字母的，如果在命令行中使用了s 选项， 其中一些命令可能会被屏蔽。</p><p>h 显示帮助画面，给出一些简短的命令总结说明</p><p>k 终止一个进程。</p><p>i 忽略闲置和僵死进程。这是一个开关式命令。</p><p>q 退出程序</p><p>r 重新安排一个进程的优先级别</p><p>S 切换到累计模式</p><p>s 改变两次刷新之间的延迟时间（单位为s），如果有小数，就换算成m s。输入0值则系统将不断刷新，默认值是5 s</p><p>f或者F 从当前显示中添加或者删除项目</p><p>o或者O 改变显示项目的顺序</p><p>l 切换显示平均负载和启动时间信息</p><p>m 切换显示内存信息</p><p>t 切换显示进程和CPU状态信息</p><p>c 切换显示命令名称和完整命令行</p><p>M 根据驻留内存大小进行排序</p><p>P 根据CPU使用百分比大小进行排序</p><p>T 根据时间/累计时间进行排序</p><p>W 将当前设置写入~/.toprc文件中</p></ul><blockquote><p>常用参数</p></blockquote><ul><li>显示 完整命令 top -c<li>以批处理模式显示程序信息 top -b<li>以累积模式显示程序信息 top -S<li>设置信息更新次数 top -n 2<li>设置信息更新时间 top -d 3<li>显示指定的进程信息 top -p 574</ul><blockquote><p>例：指定显示进程 9836，每隔 5 秒的进程的资源的占用情况</p></blockquote><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c"># top –d 5 –p 9836 -c</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%B5%84%E6%BA%90/'>资源</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E6%80%A7%E8%83%BD/" class="post-tag no-text-decoration" >性能</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Linux性能分析 - 章杰的博客&url=https://pzhjie.com//posts/linux-performance-analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Linux性能分析 - 章杰的博客&u=https://pzhjie.com//posts/linux-performance-analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Linux性能分析 - 章杰的博客&url=https://pzhjie.com//posts/linux-performance-analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/linux-performance-analysis/">Linux性能分析</a><li><a href="/posts/install-arch-linux/">ArchLinux安装</a><li><a href="/posts/book-list-of-2020/">2020阅读书单</a><li><a href="/posts/c++-build-process/">程序编译链接过程</a><li><a href="/posts/common_logic_err/">觉见逻辑错误</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/archlinux/">archlinux</a> <a class="post-tag" href="/tags/google%E8%AF%84%E5%88%86%E5%8D%A1/">Google评分卡</a> <a class="post-tag" href="/tags/rabbitmq%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">RabbitMq权限管理</a> <a class="post-tag" href="/tags/tech/">tech</a> <a class="post-tag" href="/tags/tmux/">tmux</a> <a class="post-tag" href="/tags/%E6%80%A7%E8%83%BD/">性能</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%93%E6%9E%84%E5%9E%8B/">设计模式(结构型)</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B/">设计模式(行为型)</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/%E8%B5%84%E6%BA%90/">资源</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/list-of-this-year/"><div class="card-body"> <span class="timeago small" > Jun 2, 2020 <i class="unloaded">2020-06-02T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2020资源列表</h3><div class="text-muted small"><p> 资源 技术 程序员技术资源分享群内容整理 设计模式-refactoringguru Git学习 DvaJs Redux JavaScript基础教程 ES6教程 博客 为什么这么设计-面向信仰编程 木子</p></div></div></a></div><div class="card"> <a href="/posts/general-blog-resources/"><div class="card-body"> <span class="timeago small" > Sep 14, 2018 <i class="unloaded">2018-09-14T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>我常看的IT网站</h3><div class="text-muted small"><p> 博客 王垠 王垠历史文章 酷壳网 左耳听风 云风 Brendan Gregg 冰河 银河里的星星 陈硕 栋哥 登州知府 廖雪峰 负暄琐话 李杀 CatKang 刘未鹏 菜菜博士 池建强 何登成 轮子哥 落落-SQL调优 孟岩 章炎 冯大辉 tonybai geekan Bjarne...</p></div></div></a></div><div class="card"> <a href="/posts/c++-build-process/"><div class="card-body"> <span class="timeago small" > Jan 9, 2021 <i class="unloaded">2021-01-09T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>程序编译链接过程</h3><div class="text-muted small"><p> C++的编译链接过程 在linux环境下开发C++时，理解编译、链接的原理和过程对于linux C++程序来说是一项基本功。将代码转变为可执行程序的过程大致可分为如下阶段：预编译，编译和链接。 预编译 预编译过程主要处理那些源代码文件中的以“#”开始的预编译指令。比如“#include”、”#define”等，主要的处理规则如下： 1.将所有的#define删除，并展开所有的宏定义 2...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/general-blog-resources/" class="btn btn-outline-primary"><p>我常看的IT网站</p></a> <a href="/posts/build_static_tmux/" class="btn btn-outline-primary"><p>编译静态链接tmux</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">pzhjie</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/archlinux/">archlinux</a> <a class="post-tag" href="/tags/google%E8%AF%84%E5%88%86%E5%8D%A1/">Google评分卡</a> <a class="post-tag" href="/tags/rabbitmq%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">RabbitMq权限管理</a> <a class="post-tag" href="/tags/tech/">tech</a> <a class="post-tag" href="/tags/tmux/">tmux</a> <a class="post-tag" href="/tags/%E6%80%A7%E8%83%BD/">性能</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%93%E6%9E%84%E5%9E%8B/">设计模式(结构型)</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B/">设计模式(行为型)</a> <a class="post-tag" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a> <a class="post-tag" href="/tags/%E8%B5%84%E6%BA%90/">资源</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://pzhjie.com/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
